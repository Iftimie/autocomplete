version: '3.3'
services:

  gateway:
    container_name: gateway
    image: nginx:1.19-alpine
    ports:
      - "80:80"

    depends_on:
      - distributor.backend
      - assembler.collector

    volumes:
      - ./gateway/nginx.conf:/etc/nginx/nginx.conf
      - ./gateway/www:/var/www
      - ./gateway/log:/var/log/nginx

  distributor.backend:
    build: ./distributor/backend
    ports:
      - "6000:6000"
    volumes:
      - ./distributor/backend/main.py:/app/distributor/backend/main.py
      - ./shared/trie.py:/app/distributor/backend/trie.py
      - ./shared/shared_data:/app/distributor/backend/shared_data
    command: gunicorn --chdir /app/distributor/backend main:app -b 0.0.0.0:6000 --reload

  assembler.collector:
    build: ./assembler/collector
    ports:
      - "5000:5000"
    volumes:
      - ./assembler/collector/main.py:/app/assembler/collector/main.py
      - ./shared/trie.py:/app/assembler/collector/trie.py
      - ./shared/shared_data:/app/assembler/collector/shared_data
    command: gunicorn --chdir /app/assembler/collector main:app -b 0.0.0.0:5000 --reload